<% include ../partials/head %>
<% include ../partials/header %>

<style>
    .skMainForm .form-group--float>label {
        top: -20px;
        color: #eaad4e;
        font-weight:600;
    }
    .skMainForm .data-add-search-box__cta-btn {
        background: #eaad4e;
        color: black;
        border-radius: 10px;
    }
    .DIV_BOX .data-add-search-box {
        padding: 20px 20px 30px 20px;
        box-shadow: 10px 10px 10px #bbbb;
    }
    .DIV_BOX .data-add-search-box {
        background-color: #000 !important;
    }
    .card-body {
        border: 1px solid;
    }
</style>


<div class="content__inner DIV_BOX">
  <div class="data-add-search-box skMainForm">
    <form method="post" action="/route/therapiesST" id="erp_form" autocomplete="off">
      <div class="row gutter-3">
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
            <input type="text" name="location" id="Location" class="form-control" required="required"/> 
            <label>Location</label>
            <i class="form-group__bar"></i>
          </div>
        </div>
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
            <input type="text" class="form-control" name="name" id="name" required="required"/> 
            <label>Name</label>
            <i class="form-group__bar"></i>
          </div>
        </div>
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
            <input type="text"  class="form-control" name="duration" id="Duration" /> 
            <label>Duration</label>
            <i class="form-group__bar"></i>
          </div>
        </div>
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
              <label>Title</label>
            <div class="dropdown dropdown--material dropdown--material--with-label">
              <input type="text" id="titleId" class="form-control" data-toggle="dropdown" readonly="true">
              <div class="dropdown-menu">
                <div class="form-group mb-0">
                  <textarea class="form-control" name="title" rows="3" placeholder="Title"></textarea>
                  <i class="form-group__bar"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
            <span id="backgroundImage1_loader" class="loading-text"></span>
            <input id="backgroundImage1_input" class="form-control" name="image" readonly="true" />
            <label>Background Image</label>
            <i class="form-group__bar"></i>
            <div class="file-upload btn btn-secondary btn-upload">
              <span>Upload</span>  
              <input type="file" class="upload upload_img form-control" id="uploadBtn" name="backgroundImage1">
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
            <input type="text" id="imageTitle" class="form-control" name="imageTitle">
            <label>Image Title</label>
            <i class="form-group__bar"></i>
          </div>
        </div>
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
            <input type="text" id="altText" name="altText" class="form-control">
            <label>Alt Text</label>
            <i class="form-group__bar"></i>
          </div>
        </div>
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
              <label>Description</label>
            <div class="dropdown dropdown--material dropdown--material--with-label">
              <input type="text" id="descriptionId" class="form-control" data-toggle="dropdown" readonly="true"/>
              <div class="dropdown-menu">
                <div class="form-group mb-0">
                  <textarea type="text" rows="4" id="F_DESCRIPTION" name="description" placeholder="Description" class="form-control"></textarea>
                  <i class="form-group__bar"></i>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
            <input type="text" class="form-control" name="therapiestPrice" id="therapiestPrice" /> 
            <label>Therapiest Price</label>
            <i class="form-group__bar"></i>
          </div>
        </div>
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
            <input type="text" class="form-control" name="SPAPrice" id="SPAPrice" /> 
            <label>SPA Price</label>
            <i class="form-group__bar"></i>
          </div>
        </div>
        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
            <input type="text" class="form-control" name="customerPrice" id="customerPrice"/> 
            <label>Customer Price</label>
            <i class="form-group__bar"></i>
          </div>
        </div>

        <div class="col-md-3 col-sm-4 col-12">
          <div class="form-group form-group--float form-group--float-white">
            <input type="text" class="form-control benefit" name="benefit" id="benefit"/> 
            <label>Benefit</label>
            <i class="form-group__bar"></i>
          </div>
        </div>

        
        <div class="col-md-3 col-sm-4 col-12 benefit-field">
          <div id="benefitContainer">
            <!-- First Benefit Input -->
              <div class="form-group form-group--float form-group--float-white">
                <input type="text" class="form-control benefit-input" name="benefit[]" placeholder="Enter Benefit" />
                <label>Benefit</label>
                <i class="form-group__bar"></i>
              </div>
              <button type="button" class="btn btn-danger btn-sm delete-benefit" style="display:none;">Delete</button>
            </div>
          </div>

          <div class="col-12 mt-3">
            <button type="button" id="addMore" class="btn btn-primary">Add More</button>
          </div>
        </div>

          <!-- Add More Button -->
          
        
        



      </div>

          <div class="alert alert-success alert-dismissible fade show alert-hidden" id="success-alert-add">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">×</span>
            </button>
            <strong>Success! </strong> Record added successfully.
        </div>

        <div class="alert alert-info alert-dismissible fade show alert-hidden" id="success-alert-update">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
            <strong>Success! </strong> Record Update successfully.
        </div>

      <div class="alert alert-danger alert-dismissible fade show d-none" id="success-alert-error">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">×</span>
            </button>
            <strong>Error! </strong> <span class="custom_error"></span>
      </div>


      <button type="submit" class="btn btn btn-secondary btn--raised btn-lg data-add-search-box__cta-btn get_filter_tour_data button-submit-form">Add</button>
    </form>
  </div>
  <div class="card">
    <div class="card-body">
      <table id="TherapiesTable" class="table table-bordered table-striped display nowrap order-column enqtable-custome"></table>
    </div>
  </div>
</div>

<!-- <script src="../../js/box-init.js" type="text/javascript"></script> -->

<script type="text/javascript">
  // Prevent dropdown menu from closing on click
  $('.dropdown .dropdown-menu').on({
      "click": function(e) {
          e.stopPropagation();
      }
  });

  // Close dropdown on button click
  $('.dropdown-menu-action .btn').click(function() {
      $('.dropdown').removeClass('open');
  });

  $(document).ready(function() {
      var SubmitUrlId;
      var populate_data = {};
      var action_type;
      var NewObject;
      var flag = false;

      // Define columns for the data table
      var dataColumns = [{
          data: "_id",
          visible: false
      }, {
          data: "location",
          sTitle: "Location",
          visible: true
      }, {
          data: "name",
          sTitle: "Name",
          visible: true,
          render: function(data, type, row) {
              return '<a href="#" class="grid-edit-row text-st-purple"  data-id="' + row._id + '">' + row.name + '</a>';
          }
      }, {
          data: "duration",
          sTitle: "Duration",
          visible: true
      }, {
          data: "customerPrice",
          sTitle: "Customer Price",
          visible: true
      }, {
          data: "SPAPrice",
          sTitle: "SPA Price",
          visible: true
      }, {
          data: "therapiestPrice",
          sTitle: "Therapist Price",
          visible: true
      }, {
          data: "benefit",
          sTitle: "Benefit",
          visible: true
      }, {
          data: "image",
          sTitle: "Image",
          visible: true,
          render: function(data, type, row) {
              return '<img width="50" height="50" src="' + row.image + '">';
          }
      }];

      // Initialize data table
      var DrawTableWebBannerST = DrawCustomDataTable("TherapiesTable", 350, "/route/therapiesST/gridView", dataColumns, [
          [0, "desc"]
      ], "frm_grid_search", null, true, true);

      // Form validation
      $("#erp_form").validate({
          rules: {
              title: {
                  required: true
              }
          },
          errorPlacement: function(error, element) {},
          submitHandler: function(form) {
              $(".overlay").show();
              var $form = $(form);
              var url = $form.attr('action');

              if (action_type === "PUT") {
                  url += SubmitUrlId;
              }

              var formData = $form.serializeObject();

              // Collect benefits array
              var benefits = [];
              $('input[name="benefit[]"]').each(function() {
                  if ($(this).val().trim() !== "") {
                      benefits.push($(this).val().trim());
                  }
              });
              formData.benefit = benefits;

              // Append version if available
              if (NewObject) {
                  formData.__v = NewObject.__v;
              }

              // AJAX request
              $.ajax({
                  url: url,
                  type: action_type || "POST",
                  data: JSON.stringify(formData),
                  contentType: "application/json; charset=utf-8",
                  dataType: "json",
                  success: function(result) {
                      document.getElementById("erp_form").reset();
                      $("#overlayimage1_img, #backgroundImage1_img, #attractionImage1_img").html('');
                      $(".overlay").hide();

                      if (action_type === "PUT") {
                          $("#success-alert-update").alert();
                          $("#success-alert-update").fadeTo(2000, 500).slideUp(500);
                      } else {
                          $("#success-alert-add").alert();
                          $("#success-alert-add").fadeTo(2000, 500).slideUp(500);
                      }

                      DrawTableWebBannerST.ajax.reload();
                      $('#healthBenefitsModal').modal('hide');
                  },
                  error: function(jqXHR, textStatus, errorThrown) {
                      $(".overlay").hide();
                      var result = jQuery.parseJSON(jqXHR.responseText);
                      $(".custom_error").html(result.message || errorThrown);
                      $("#success-alert-error").alert();
                      $("#success-alert-error").fadeTo(2000, 500).slideUp(500);
                  }
              });
          }
      });

      // Add More Benefits dynamically
      const addMoreBtn = document.getElementById('addMore');
      const benefitContainer = document.getElementById('benefitContainer');

      addMoreBtn.addEventListener('click', function() {
          const newBenefitField = document.createElement('div');
          newBenefitField.classList.add('col-md-3', 'col-sm-4', 'col-12', 'benefit-field');
          newBenefitField.innerHTML = `
              <div class="form-group form-group--float form-group--float-white">
                <input type="text" class="form-control" name="benefit[]" placeholder="Enter Benefit" />
                <label>Benefit</label>
                <i class="form-group__bar"></i>
              </div>
              <button type="button" class="btn btn-danger btn-sm delete-benefit">Delete</button>
          `;
          benefitContainer.appendChild(newBenefitField);

          // Add delete functionality to newly added benefit fields
          const deleteBtn = newBenefitField.querySelector('.delete-benefit');
          deleteBtn.addEventListener('click', function() {
              newBenefitField.remove();
          });
      });

      // Pre-existing delete benefit button
      const initialDeleteBtn = document.querySelector('.delete-benefit');
      if (initialDeleteBtn) {
          initialDeleteBtn.addEventListener('click', function() {
              initialDeleteBtn.closest('.benefit-field').remove();
          });
      }

      // Handle Edit Row click
      $(document).on('click', '.grid-edit-row', function() {
          $(".overlay").show();
          var id = $(this).attr("data-id");
          var url = "/route/therapiesST/" + id;

          $.get(url, {}, function(data) {
              populate_data = data;

              if (data.overlayimage) {
                  $("#overlayimage1_img").html('<a href="' + data.overlayimage + '" target="_new"><img src="' + data.overlayimage + '" width="50" height="50"></a>');
              }
              if (data.image) {
                  $("#backgroundImage1_img").html('<a href="' + data.image + '" target="_new"><img src="' + data.image + '" class="img-thumbnail" style="height:50px;width:90px;"></a>');
              }

              $.when($('#erp_form').populate(data)).done(function() {
                  SubmitUrlId = "/" + populate_data._id;
                  action_type = "PUT";
                  NewObject = data;
                  $(".overlay").hide();
                  $(".form_add_entry").show();
              });
          });
      });

      // Image upload handler
      $(document).on("change", ".upload_img", function() {
          var name = $(this).attr("name");
          var file_data = $(this).prop("files")[0];
          var form_data = new FormData();
          form_data.append("path", 'therapiesST');
          form_data.append("file", file_data);
          $("#" + name + "_loader").html("Loading...");

          $.ajax({
              url: "/route/upload/aws",
              type: 'post',
              data: form_data,
              cache: false,
              enctype: 'multipart/form-data',
              processData: false,
              contentType: false,
              success: function(result) {
                  var data = JSON.stringify(result);
                  data = JSON.parse(data);
                  if (data.url) {
                      $("#" + name + "_input").val(data.url);
                      $("#" + name + "_img").html('<a href="' + data.url + '" target="_new"><img src="' + data.url + '" class="img-thumbnail" style="height:50px;width:90px;"></a>');
                      $("#" + name + "_loader").html('');
                  }
              },
              error: function(jqXHR) {
                  var result = jQuery.parseJSON(jqXHR.responseText);
                  $(".custom_error").html(result.message);
              }
          });
      });
  });
</script>


<!-- <script type="text/javascript">
    $('.dropdown .dropdown-menu').on({
        "click": function(e) {
            e.stopPropagation();
        }
    });

    $('.dropdown-menu-action .btn').click(function() {
        $('.dropdown').removeClass('open');
    });

    $(document).ready(function() {
         //$("#F_DESCRIPTION").wysihtml5();
        var SubmitUrlId;
        var populate_data = {};
        var action_type;
        var NewObject;
        var flag = false;

        var dataColumns = [{
            data: "_id",
            visible: false
        }, {
            data: "location",
            sTitle: "Location",
            visible: true,
            // className: "column-200",
        }, {
            data: "name",
            sTitle: "Name",
            visible: true,
            // className: "column-120",
            render: function(data, type, row) {
                return '<a href="#" class="grid-edit-row text-st-purple"  data-id="' + row._id + '">' + row.name + '</a>'
            }
        }, {
            data: "duration",
            sTitle: "Duration",
            visible: true,
            // className: "column-200",
        }, {
            data: "customerPrice",
            sTitle: "Customer Price",
            visible: true,
            // className: "column-200",
        }, {
            data: "SPAPrice",
            sTitle: "SPA Price",
            visible: true,
            // className: "column-200",
        }, {
            data: "therapiestPrice",
            sTitle: "Therapist Price",
            visible: true,
            // className: "column-200",
        }, {
            data: "image",
            sTitle: "Image",
            visible: true,
            render: function(data, type, row) {
                return '<img width="50" height="50" src="' + row.image + '">'
            }
            // className: "column-200",
        }];

        var DrawTableWebBannerST = DrawCustomDataTable("TherapiesTable", 350, "/route/therapiesST/gridView", dataColumns, [
            [0, "desc"],

        ], "frm_grid_search", null, true, true, undefined, undefined, undefined);
        $("#frm_grid_search").validate({
            errorPlacement: function(error, element) {},
            submitHandler: function(form) {
                DrawTableIdeaPool.ajax.reload();
            }
        });

        $(document).on('click', '.grid-edit-row', function() {
            $(".overlay").show();
            $('.add-off').attr('disabled', 'disabled');
            var id = $(this).attr("data-id");
            $(".form-title").html("Edit Therapies");
            $(".button-submit-form").html("Update");
            document.getElementById("erp_form").reset();
            //   createBanner();
            $("#overlayimage1_img").html('');
            $("#backgroundImage1_img").html('');
            $("#attractionImage1_img").html('');
            $(".select2").select2();
            $("#sectorDiv").remove();
            $("#landingDiv").remove();
            var id = $(this).attr("data-id");
            var url = "/route/therapiesST/" + id;
            $.get(url, {}, function(data) {
                populate_data = data;

                if (data.overlayimage) {
                    $("#overlayimage1_img").html('<a href="' + data.overlayimage + '" target="_new"><img src="' + data.overlayimage + '" width="50" height="50"></a>');
                } else {
                    $("#overlayimage1_img").html('');
                }
                if (data.image) {
                    $("#backgroundImage1_img").html('<a href="' + data.image + '" target="_new"><img src="' + data.image + '" class="img-thumbnail" style="height:50px;width:90px;"></a>');
                } else {
                    $("#backgroundImage1_img").html('');
                }


                $.when($('#erp_form').populate(data)).done(function(x) {
                    $('.select2').select2();
                    SubmitUrlId = "/" + populate_data._id;
                    action_type = "PUT";
                    NewObject = data;
                    flag = true;
                    $('#titleId').val(data.title);
                    // $('#descriptionId').val(data.description);
                    $('.select2').select2();
                    $(".overlay").hide();
                    $(".form_add_entry").show();

                });

            });
            // alert( "Handler for .click() called." );
        });
        $("form#erp_form").submit(function(e) {
            e.preventDefault();
        })

        $("#erp_form").validate({
            rules: {
                title: {
                    required: true
                },
            },
            errorPlacement: function(error, element) {},
            submitHandler: function(form) {
                $(".overlay").show();
                var $form = $(form);
                var url = $form.attr('action');
                if (action_type == "PUT") {
                    url += SubmitUrlId;
                }
                var formData = $form.serializeObject();
                if (NewObject) {
                    formData.__v = NewObject.__v;
                } /* post method */
                $.ajax({
                    url: url,
                    type: action_type || "POST",
                    data: JSON.stringify(formData),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function(result) {
                        document.getElementById("erp_form").reset();
                        $("#overlayimage1_img").html('');
                        $("#backgroundImage1_img").html('');
                        $("#attractionImage1_img").html('');
                        if (result.message) {
                            $(".overlay").hide();

                            if (action_type == "PUT") {
                                $("#success-alert-update").alert();
                                $("#success-alert-update").fadeTo(2000, 500).slideUp(500, function() {});
                                DrawTableWebBannerST.ajax.reload();
                                $('#healthBenefitsModal').modal('hide');

                            } else {
                                $("#success-alert-add").alert();
                                $("#success-alert-add").fadeTo(2000, 500).slideUp(500, function() {});
                                document.getElementById("erp_form").reset();
                                DrawTableWebBannerST.ajax.reload();
                                $('#healthBenefitsModal').modal('hide');
                            }

                        }
                    },
                    error: function(jqXHR, textStatus, errorThrown) {
                        $(".overlay").hide();
                        if (jqXHR.status == 200 || jqXHR.status == 302) {
                            window.location.href = '/login';
                        }
                        var result = jQuery.parseJSON(jqXHR.responseText);
                        if (jqXHR.status == 500) {

                            $(".custom_error").html(result.message);

                            $("#success-alert-error").alert();

                            $("#success-alert-error").fadeTo(2000, 500).slideUp(500, function() {});
                            // alert('Internal error: ' + jqXHR.responseText);
                        } else {
                            $(".custom_error").html(errorThrown);
                            $("#success-alert-error").alert();

                            $("#success-alert-error").fadeTo(2000, 500).slideUp(500, function() {});
                        }
                    }
                });

            }
        });

        $(document).on("change", ".upload_img", function() {
            //alert("hi");
            var $this = $(this);
            var name = $(this).attr("name");
            var file_data = $(this).prop("files")[0]; // Getting the properties of file from file field
            var form_data = new FormData(); // Creating object of FormData class
            form_data.append("path", 'therapiesST'); // Adding extra parameters to form_data

            form_data.append("file", file_data); // Appending parameter named file with properties of file_field to form_data
            $("#" + name + "_loader").html("Loading...");
            $.ajax({
                url: "/route/upload/aws",
                type: 'post',
                // dataType: 'json',
                data: form_data,
                cache: false,
                enctype: 'multipart/form-data',
                processData: false, // tell jQuery not to process the data
                contentType: false, // tell jQuery not to set contentType
                success: function(result) {
                    var data = JSON.stringify(result);
                    data = JSON.parse(data);
                    if (data.url) {
                        if ((data.url).indexOf('https') > -1) {} else {
                            data.url = data.url.replace(/http/g, 'https');
                        }
                        $("#" + name + "_input").val(data.url);
                        $("#" + name + "_img").html('<a href="' + data.url + '" target="_new"><img src="' + data.url + '" class="img-thumbnail" style="height:50px;width:90px;"></a>');
                        $("#" + name + "_loader").html('');
                    }
                },
                error: function(jqXHR, textStatus, errorThrown) {
                    var result = jQuery.parseJSON(jqXHR.responseText);
                    $(".custom_error").html(result.message);
                }
            });
        });
    });
</script> -->


<% include ../partials/footer %>
