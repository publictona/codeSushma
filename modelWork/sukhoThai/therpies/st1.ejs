<% include ../partials/head %>
  <% include ../partials/header %>

    <style>
      .skMainForm .form-group--float>label {
        top: -20px;
        color: #eaad4e;
        font-weight: 600;
      }

      .skMainForm .data-add-search-box__cta-btn {
        background: #eaad4e;
        color: black;
        border-radius: 10px;
      }

      .DIV_BOX .data-add-search-box {
        padding: 20px 20px 30px 20px;
        box-shadow: 10px 10px 10px #bbbb;
      }

      .DIV_BOX .data-add-search-box {
        background-color: #000 !important;
      }

      .card-body {
        border: 1px solid;
      }

      .benefit-field {
        padding-left: 19px;
      }

      .benefit-input {
        padding-left: 1.5rem!important;
      }
    </style>


    <div class="content__inner DIV_BOX">
      <div class="data-add-search-box skMainForm">
        <form method="post" action="/route/therapiesST" id="erp_form" autocomplete="off">
          <div class="row gutter-3">
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <input type="text" name="location" id="Location" class="form-control" required="required" />
                <label>Location</label>
                <i class="form-group__bar"></i>
              </div>
            </div>
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <input type="text" class="form-control" name="name" id="name" required="required" />
                <label>Name</label>
                <i class="form-group__bar"></i>
              </div>
            </div>
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <input type="text" class="form-control" name="duration" id="Duration" />
                <label>Duration</label>
                <i class="form-group__bar"></i>
              </div>
            </div>
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <label>Title</label>
                <div class="dropdown dropdown--material dropdown--material--with-label">
                  <input type="text" id="titleId" class="form-control" data-toggle="dropdown" readonly="true">
                  <div class="dropdown-menu">
                    <div class="form-group mb-0">
                      <textarea class="form-control" name="title" rows="3" placeholder="Title"></textarea>
                      <i class="form-group__bar"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <span id="backgroundImage1_loader" class="loading-text"></span>
                <input id="backgroundImage1_input" class="form-control" name="image" readonly="true" />
                <label>Background Image</label>
                <i class="form-group__bar"></i>
                <div class="file-upload btn btn-secondary btn-upload">
                  <span>Upload</span>
                  <input type="file" class="upload upload_img form-control" id="uploadBtn" name="backgroundImage1">
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <input type="text" id="imageTitle" class="form-control" name="imageTitle">
                <label>Image Title</label>
                <i class="form-group__bar"></i>
              </div>
            </div>
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <input type="text" id="altText" name="altText" class="form-control">
                <label>Alt Text</label>
                <i class="form-group__bar"></i>
              </div>
            </div>
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <label>Description</label>
                <div class="dropdown dropdown--material dropdown--material--with-label">
                  <input type="text" id="descriptionId" class="form-control" data-toggle="dropdown" readonly="true" />
                  <div class="dropdown-menu">
                    <div class="form-group mb-0">
                      <textarea type="text" rows="4" id="F_DESCRIPTION" name="description" placeholder="Description"
                        class="form-control"></textarea>
                      <i class="form-group__bar"></i>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <input type="text" class="form-control" name="therapiestPrice" id="therapiestPrice" />
                <label>Therapiest Price</label>
                <i class="form-group__bar"></i>
              </div>
            </div>
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <input type="text" class="form-control" name="SPAPrice" id="SPAPrice" />
                <label>SPA Price</label>
                <i class="form-group__bar"></i>
              </div>
            </div>
            <div class="col-md-3 col-sm-4 col-12">
              <div class="form-group form-group--float form-group--float-white">
                <input type="text" class="form-control" name="customerPrice" id="customerPrice" />
                <label>Customer Price</label>
                <i class="form-group__bar"></i>
              </div>
            </div>

            

       
  <div class="col-md-12 mt-2">
     <h5>Therapies Benefit</h5>
    <div class="row col-md-12">
    
      <div class="col-md-10">
        <input type="text" class="form-control" name="benefit[]" placeholder="Enter Benefit" />
      </div>

     
      <div class="col-md-1">
        <button type="button" id="addMore" class="btn btn-success btn-block">+</button>
      </div>

     
      <div class="col-md-1">
        <!-- <button type="button" class="btn btn-warning btn-block edit-benefit">X</button> -->
      </div>
    </div>
    <div id="benefitContainer"></div>
  </div> 

  <!-- delete-benefit -->
  <!-- <div class="col-md-12 mt-2">
    <h5>Therapies Benefit</h5>
  
    <div id="benefitContainer">
   
    </div>
  
    <div class="row col-md-12 mt-2">
        <div class="col-md-10">
            <input type="text" class="form-control" name="benefit[]" placeholder="Enter Benefit" />
        </div>
        <div class="col-md-1">
            <button type="button" id="addMore" class="btn btn-success btn-block">+</button>
        </div>
    </div>
</div> -->






          </div>

          <div class="alert alert-success alert-dismissible fade show alert-hidden" id="success-alert-add">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">×</span>
            </button>
            <strong>Success! </strong> Record added successfully.
          </div>

          <div class="alert alert-info alert-dismissible fade show alert-hidden" id="success-alert-update">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
            <strong>Success! </strong> Record Update successfully.
          </div>

          <div class="alert alert-danger alert-dismissible fade show d-none" id="success-alert-error">
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
              <span aria-hidden="true">×</span>
            </button>
            <strong>Error! </strong> <span class="custom_error"></span>
          </div>


          <button type="submit"
            class="btn btn btn-secondary btn--raised btn-lg data-add-search-box__cta-btn get_filter_tour_data button-submit-form">Add</button>
        </form>
      </div>
      <div class="card">
        <div class="card-body">
          <table id="TherapiesTable"
            class="table table-bordered table-striped display nowrap order-column enqtable-custome"></table>
        </div>
      </div>
    </div>

    <!-- <script src="../../js/box-init.js" type="text/javascript"></script> -->

    <script type="text/javascript">
      // Prevent dropdown menu from closing on click
      $('.dropdown .dropdown-menu').on({
        "click": function (e) {
          e.stopPropagation();
        }
      });

      // Close dropdown on button click
      $('.dropdown-menu-action .btn').click(function () {
        $('.dropdown').removeClass('open');
      });

      $(document).ready(function () {
        var SubmitUrlId;
        var populate_data = {};
        var action_type;
        var NewObject;
        var flag = false;

        // Define columns for the data table
        var dataColumns = [{
          data: "_id",
          visible: false
        }, {
          data: "location",
          sTitle: "Location",
          visible: true
        }, {
          data: "name",
          sTitle: "Name",
          visible: true,
          render: function (data, type, row) {
            return '<a href="#" class="grid-edit-row text-st-purple"  data-id="' + row._id + '">' + row.name + '</a>';
          }
        }, {
          data: "duration",
          sTitle: "Duration",
          visible: true
        }, {
          data: "customerPrice",
          sTitle: "Customer Price",
          visible: true
        }, {
          data: "SPAPrice",
          sTitle: "SPA Price",
          visible: true
        }, {
          data: "therapiestPrice",
          sTitle: "Therapist Price",
          visible: true
        }, {
          data: "benefit",
          sTitle: "Benefit",
          visible: true
        }, {
          data: "image",
          sTitle: "Image",
          visible: true,
          render: function (data, type, row) {
            return '<img width="50" height="50" src="' + row.image + '">';
          }
        }];

        // Initialize data table
        var DrawTableWebBannerST = DrawCustomDataTable("TherapiesTable", 350, "/route/therapiesST/gridView", dataColumns, [
          [0, "desc"]
        ], "frm_grid_search", null, true, true);

        // Form validation
        $("#erp_form").validate({
          rules: {
            title: {
              required: true
            }
          },
          errorPlacement: function (error, element) { },
          submitHandler: function (form) {
            $(".overlay").show();
            var $form = $(form);
            var url = $form.attr('action');

            if (action_type === "PUT") {
              url += SubmitUrlId;
            }

            var formData = $form.serializeObject();

            // Collect benefits array
            var benefits = [];
            $('input[name="benefit[]"]').each(function () {
              if ($(this).val().trim() !== "") {
                benefits.push($(this).val().trim());
              }
            });
            formData.benefit = benefits;

            // Append version if available
            if (NewObject) {
              formData.__v = NewObject.__v;
            }

            // AJAX request
            $.ajax({
              url: url,
              type: action_type || "POST",
              data: JSON.stringify(formData),
              contentType: "application/json; charset=utf-8",
              dataType: "json",
              success: function (result) {
                document.getElementById("erp_form").reset();
                $("#overlayimage1_img, #backgroundImage1_img, #attractionImage1_img").html('');
                $(".overlay").hide();

                if (action_type === "PUT") {
                  $("#success-alert-update").alert();
                  $("#success-alert-update").fadeTo(2000, 500).slideUp(500);
                } else {
                  $("#success-alert-add").alert();
                  $("#success-alert-add").fadeTo(2000, 500).slideUp(500);
                }

                DrawTableWebBannerST.ajax.reload();
                $('#healthBenefitsModal').modal('hide');
              },
              error: function (jqXHR, textStatus, errorThrown) {
                $(".overlay").hide();
                var result = jQuery.parseJSON(jqXHR.responseText);
                $(".custom_error").html(result.message || errorThrown);
                $("#success-alert-error").alert();
                $("#success-alert-error").fadeTo(2000, 500).slideUp(500);
              }
            });
          }
        });
         //-----------------------------start---------------------------------------------

    //     const benefitContainer = document.getElementById('benefitContainer');

    //        $(document).on('click', '#addMore', function() {
    //     const newBenefitField = document.createElement('div');
    //     newBenefitField.classList.add('row','col-md-12', 'mt-1');  // Add 'row' and margin-top for spacing
    //     newBenefitField.innerHTML = `
    //         <div class="col-md-10">
    //             <input type="text" class="form-control" name="benefit[]" placeholder="Enter Benefit" />
    //         </div>
    //         <div class="col-md-1">
    //             <button type="button" class="btn btn-success btn-block">
    //                 +
    //             </button>
    //         </div>
    //         <div class="col-md-1">
    //             <button type="button" class="btn btn-danger btn-block delete-benefit">
    //                 X
    //             </button>
    //         </div>
    //     `;
    //     benefitContainer.appendChild(newBenefitField);

    //     // Delete button for dynamically added benefit fields
    //     const deleteBtn = newBenefitField.querySelector('.delete-benefit');
    //     deleteBtn.addEventListener('click', function() {
    //         newBenefitField.remove();
    //     });
    // });

        
    //       const initialDeleteBtn = document.querySelector('.delete-benefit');
    //       if (initialDeleteBtn) {
    //           initialDeleteBtn.addEventListener('click', function() {
    //               initialDeleteBtn.closest('.row').remove();
    //           });
    //       }


    //------------------------------end--------------------------------------------

// $(document).on('click', '.grid-edit-row', function () {
//     $(".overlay").show();
//     var id = $(this).attr("data-id");
//     var url = "/route/therapiesST/" + id;

//     $.get(url, {}, function (data) {
//         populate_data = data;

//         // Populate the form fields
//         $.when($('#erp_form').populate(data)).done(function () {
//             SubmitUrlId = "/" + populate_data._id;
//             action_type = "PUT";
//             NewObject = data;
//             $(".overlay").hide();
//             $(".form_add_entry").show();

//             // Clear existing dynamic benefit fields
//             $('#benefitContainer').empty();

//             // Split the 0th index of benefit array if it contains a comma
//             if (data.benefit && data.benefit.length > 0 && data.benefit[0].includes(',')) {
//                 var splitBenefits = data.benefit[0].split(',');  // Split the string at the comma

//                 // Replace the original 0th index with the first part of the split
//                 data.benefit[0] = splitBenefits[0].trim();

//                 // Insert the second part of the split into the 1st index
//                 data.benefit.splice(1, 0, splitBenefits[0].trim());
//             }

//             // Loop through the benefit array and create input fields for each item
//             if (data.benefit && Array.isArray(data.benefit)) {
//                 data.benefit.forEach(function (benefitValue, index) {
//                     // Create a new benefit input field for each benefit item
//                     var newBenefitField = `
//                       <div class="row col-md-12 mt-2 benefit-row">
//                         <div class="col-md-10">
//     <input type="text" class="form-control" name="benefit[${index}]" value="${benefitValue}" placeholder="Enter Benefit ${index + 1}" />
// </div>
//                           <div class="col-md-1">
//                               <button type="button" class="btn btn-success btn-block add-benefit">+</button>
//                           </div>
//                           <div class="col-md-1">
//                               <button type="button" class="btn btn-danger btn-block delete-benefit">X</button>
//                           </div>
//                       </div>
//                     `;

//                     // Append the new benefit field to the container
//                     $('#benefitContainer').append(newBenefitField);
//                 });

//                 // Add delete functionality to the newly added delete-benefit buttons
//                 $('.delete-benefit').on('click', function () {
//                     $(this).closest('.benefit-row').remove();  // Remove the entire row
//                 });
//             }
//         });
//     });
// });

$(document).on('click', '.grid-edit-row', function () {
    $(".overlay").show();
    var id = $(this).attr("data-id");
    var url = "/route/therapiesST/" + id;

    $.get(url, {}, function (data) {
        populate_data = data;

        // Populate the form fields
        $.when($('#erp_form').populate(data)).done(function () {
            SubmitUrlId = "/" + populate_data._id;
            action_type = "PUT";
            NewObject = data;
            $(".overlay").hide();
            $(".form_add_entry").show();

            // Clear existing dynamic benefit fields
            $('#benefitContainer').empty();

            // Step 1: Loop through the benefit array and create input fields for each item
            if (data.benefit && Array.isArray(data.benefit)) {
                data.benefit.forEach(function (benefitValue, index) {
                    // Create a new benefit input field for each benefit item
                    var newBenefitField = `
                        <div class="row col-md-12 mt-2 benefit-row">
                            <div class="col-md-10">
                                <input type="text" class="form-control" name="benefit[${index}]" value="${benefitValue}" placeholder="Enter Benefit ${index + 1}" />
                            </div>
                            <div class="col-md-1">
                                <button type="button" class="btn btn-danger btn-block delete-benefit">X</button>
                            </div>
                            <div class="col-md-1">
                               
                            </div>
                            
                        </div>
                    `;

                    // Append the new benefit field to the container
                    $('#benefitContainer').append(newBenefitField);
                });

                // Add delete functionality to the newly added delete-benefit buttons
                $('.delete-benefit').on('click', function () {
                    $(this).closest('.benefit-row').remove();  // Remove the entire row
                });
            }
        });
    });
});

// Functionality to dynamically add more benefits
$(document).on('click', '#addMore', function () {
    const newBenefitField = `
        <div class="row col-md-12 mt-2 benefit-row">
            <div class="col-md-10">
                <input type="text" class="form-control" name="benefit[]" placeholder="Enter Benefit" />
            </div>
            <div class="col-md-1">
                <button type="button" class="btn btn-danger btn-block delete-benefit">X</button>
            </div>
            <div class="col-md-1">
               
            </div>
            
        </div>
    `;
    //  <button type="button" class="btn btn-success btn-block add-benefit">+</button>

    // Append the new benefit field to the container
    $('#benefitContainer').append(newBenefitField);

    // Add delete functionality to the newly added delete-benefit buttons
    $('.delete-benefit').on('click', function () {
        $(this).closest('.benefit-row').remove();  // Remove the entire row
    });
});




  // Image upload handler
        $(document).on("change", ".upload_img", function () {
          var name = $(this).attr("name");
          var file_data = $(this).prop("files")[0];
          var form_data = new FormData();
          form_data.append("path", 'therapiesST');
          form_data.append("file", file_data);
          $("#" + name + "_loader").html("Loading...");

          $.ajax({
            url: "/route/upload/aws",
            type: 'post',
            data: form_data,
            cache: false,
            enctype: 'multipart/form-data',
            processData: false,
            contentType: false,
            success: function (result) {
              var data = JSON.stringify(result);
              data = JSON.parse(data);
              if (data.url) {
                $("#" + name + "_input").val(data.url);
                $("#" + name + "_img").html('<a href="' + data.url + '" target="_new"><img src="' + data.url + '" class="img-thumbnail" style="height:50px;width:90px;"></a>');
                $("#" + name + "_loader").html('');
              }
            },
            error: function (jqXHR) {
              var result = jQuery.parseJSON(jqXHR.responseText);
              $(".custom_error").html(result.message);
            }
          });
        });
      });
    </script>



<% include ../partials/footer %>