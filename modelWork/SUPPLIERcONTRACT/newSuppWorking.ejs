<% include ../partials/head %>
    <% include ../partials/header %>
        <style>
            .contentRow {
                white-space: break-spaces !important;
            }

            .tourcode,
            .formno {
                text-transform: uppercase;
                font-size: 16px;
                font-weight: 800;
            }

            .tourname {
                font-size: 12px;
            }

            .tour-detials {
                font-size: 15px;
                white-space: nowrap;
            }

            .background-box {
                background: #dadada;
                padding: 1px 5px;
                border-radius: 4px;
            }

            .col-150 {
                min-width: 150px;
                max-width: 150px;
                width: 150px;
            }

            .col-50 {
                min-width: 50px;
                max-width: 50px;
                width: 50px;
            }

            .alert {
                width: auto;
                padding: 20px;
                font-size: 15px;
                top: 63px !important;
                right: 20px !important;
                z-index: 999999 !important;
            }

            .ibTable tr td {
                padding: 3px;
            }

            .calIpBox {
                border-bottom: 1px solid #fff;
            }

            label.error {
                display: block !important;
            }
        </style>

        <div id="mySidenav" class="hamburger-menu">
            <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
            <div class="hamburger-content">
                <!-- <form id="frm-grid-search" name="frm-grid-search">
            <div class="box bgff">
                <label for="mice_branch">TOURCODE</label>
                <select class="form-control select2" name="TOURCODE" id="TOURCODE"></select>
            </div>
            <div class="box bgff">
                <label for="TOURNAME">TOURNAME</label>
                <select class="form-control select2 " name="TOURNAME" id="TOURNAME"></select>
            </div>
            
            <div class="bgff">
                <button type="submit" class="btn btn-primary btn-guest height-30 btn-block" onclick="closeNav()">SEARCH</button>
            </div>
       </form> -->
            </div>
        </div>


        <div class="box">
            <div class="box-header with-border with-hamburger">
                <a href="javascript:void(0);" class="box-header-hamburger-menu" onclick="openNav()">
                    <i class="fa fa-bars" aria-hidden="true"></i>
                </a>
                <h3 class="box-title">Load Contract Supplier</h3>
            </div>
            <div class="box-body">
                <div class="row gutter--3px">
                    <div class="col-md-12">
                        <span class="btn btn-primary" onclick="addNewUser()"><i class="fa fa-plus"></i> Add Load
                            Contract Supplier</span>
                    </div>
                    <div class="col-md-12 r-col">
                        <table id="uspList" class="table table-bordered table-striped display nowrap order-column"
                            style="width:100%;">
                            <tbody class="appar">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal fade" id="newUserBox" tabindex="-1" role="dialog" aria-labelledby="newUserBox"
            aria-hidden="true">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">Add Load Contract Supplier Details <span id="topTranNo"
                            class="fs15--design"> </span></h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="regForm">
                            <div class="row gutter--3px">
                                <div class="col-md-12">
                                    <div class="row gutter--3px">


                                        <div class="form-group row col-sm-12">
                                            <input type="hidden" class="form-control id" name="id" value="0">
                                            <label for="" class="col-sm-3 col-form-label fs15--design">Tour Series:
                                            </label>
                                            <div class="col-sm-9">
                                                <input type="text" class="form-control" id="tourSeries"
                                                    name="tourSeries" oninput="this.value = this.value.toUpperCase();"
                                                    maxlength="2" minlength="2" autocomplete="off" />
                                            </div>
                                        </div>



                                        <!-- ------------s----- -->


                                        <div class="form-group row col-sm-12">
                                            <label for="F_CATCODE_LIST"
                                                class="col-sm-3 col-form-label fs15--design">Supplier Category:</label>
                                            <div class="col-sm-9">
                                                <select class="form-control suppliercat" id="suppliercat"
                                                    onchange="getsupplier()" name="suppliercat" required>
                                                    <option value=""></option>
                                                </select>


                                            </div>
                                        </div>

                                        <div class="form-group row col-sm-12">
                                            <label for="" class="col-sm-3 col-form-label fs15--design">Supplier
                                                Name:</label>
                                            <div class="col-sm-9">
                                                <select class="form-control supplier" id="supplier" name="supplier"
                                                    onchange="setsupplierDetails(this)">
                                                    <option value=""></option>
                                                </select>


                                            </div>
                                        </div>

                                        <div class="form-group row col-sm-12">
                                            <label for="" class="col-sm-3 col-form-label fs15--design">Supplier
                                                No:</label>
                                            <div class="col-sm-9">
                                                <input type="number" class="form-control supplier_no" name="supplier_no"
                                                    id="supplier_no" />
                                            </div>
                                        </div>

                                        <div class="form-group row col-sm-12">
                                            <label for="" class="col-sm-3 col-form-label fs15--design"> Hotel Place:
                                            </label>
                                            <div class="col-sm-9">
                                                <input type="text" name="hotelPlace" class="form-control"
                                                    id="hotelPlace">
                                            </div>
                                        </div>

                                        <div class="form-group row col-sm-12">
                                            <label for="" class="col-sm-3 col-form-label fs15--design"> Hotel Category:
                                            </label>
                                            <div class="col-sm-9">
                                                <input type="text" name="supplier_category" class="form-control"
                                                    id="supplier_category">
                                            </div>
                                        </div>



                                        <div class="form-group row col-sm-12">
                                            <label for="" class="col-sm-3 col-form-label fs15--design">Contract
                                                Content:</label>
                                            <div class="col-sm-9">
                                                <textarea type="text" class="form-control" id="contract_content"
                                                    name="contract_content"></textarea>
                                            </div>
                                        </div>



                                        <div class="form-group row col-sm-12">
                                            <label for="" class="col-sm-3 col-form-label fs15--design"> From Date:
                                            </label>
                                            <div class="col-sm-9">
                                                <input type="date" class="form-control" id="validFrom"
                                                    name="validFrom" />
                                            </div>
                                        </div>

                                        <div class="form-group row col-sm-12">
                                            <label for="" class="col-sm-3 col-form-label fs15--design"> To Date:
                                            </label>
                                            <div class="col-sm-9">
                                                <input type="date" class="form-control" id="validTo" name="validTo" />
                                            </div>
                                        </div>



                                        <div class="form-group row col-sm-12">
                                            <label for="" class="col-sm-3 col-form-label fs15--design">
                                                Upload File:
                                            </label>


                                            <div class="col-md-9 mt-10">
                                                <input type="hidden" class="upsImg" name="uspImg" value="">
                                                <input type="file" class="form-control upload_img">
                                            </div>
                                        </div>

                                    </div>
                                </div>
                                <div class="col-md-12 mt-10">

                                    <button type="submit" class="btn btn-primary btn-block">SAVE</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="tourfileLockHistory" class="modal fade" role="dialog">
            <div class="modal-dialog modal-dialog modal-md">
                <div class="modal-content">
                    <div class="modal-header modal-otp-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>

                        </button>
                        <h2>TOURFILE LOCK UNLOCK HISTORY</h2>

                    </div>
                    <div class="modal-body modal-body-otp" id="modalBody">
                        <table class="table table-bordered table-striped" style="width:100%;">
                            <thead>
                                <tr>
                                    <th>TR_FILEBY</th>
                                    <th>TR_FILEDT</th>
                                    <th>TR_FILEREM</th>
                                    <th>Action</th>
                                    <th>Action By</th>
                                </tr>
                            </thead>
                            <tbody>

                            </tbody>
                        </table>

                    </div>
                </div>
            </div>
        </div>

        <script>
            var DrawTableInquiry;
            $(document).ready(function () {
                // $('.TOUR_TYPE').select2();
                // $('.TOUR_FOR').select2();
                getTourcode();
                getsuppliercat();
                category_list()

                var dataColumns = [{
                    data: "_id",
                    sTitle: "Id",
                    visible: false
                },
                {
                    data: "tranNo",
                    sTitle: "Tran#",
                    visible: true,
                    className: "fs14--design column-12",

                },

                {
                    data: "supplier_no",
                    sTitle: "Supp. No#",
                    visible: true,
                    className: "fs14--design column-12",

                },

                {
                    data: "tourSeries",
                    sTitle: "Tour Series#",
                    visible: true,
                    className: "fs14--design",

                },

                {
                    data: "suppliercat",
                    sTitle: "Supplier Category#",
                    visible: true,
                    className: "fs14--design",

                },

                {
                    data: "supplier",
                    sTitle: "Supplier/Hotel Name#",
                    visible: true,
                    className: "fs14--design",

                },

                {
                    data: "hotelPlace",
                    sTitle: "Hotel Place#",
                    visible: true,
                    className: "fs14--design",

                },



                {
                    data: "contract_content",
                    sTitle: "Contract Content#",
                    visible: true,
                    className: "fs14--design",

                },

                {
                    data: "validFrom",
                    sTitle: "From Date#",
                    visible: false,
                    className: "fs14--design",
                    render: function (data, type, row) {
                        var html = "";
                        return dateFormat(row.validFrom);
                    }
                },

                {
                    data: "validTo",
                    sTitle: "Date",
                    visible: true,
                    className: "fs14--design column-120",
                    render: function (data, type, row) {
                        return row.validFrom + ' - ' + row.validTo;
                    }
                },




                {
                    data: "validTo",
                    sTitle: "To Date#",
                    visible: false,
                    className: "fs14--design",
                    render: function (data, type, row) {

                        var html = "";
                        return dateFormat(row.validTo);
                    }
                },

                {
                    data: "Supplier",
                    sTitle: "Action",
                    visible: true,
                    render: function (data, type, row) {
                        //console.log(row);
                        var html =
                            ' <span class="btn btn-primary btn-block" data-id="' + row
                                ._id +
                            '" onclick="getUser(this) "> Edit</span>';
                        return html;
                    }
                },

                {
                    data: "uploadFile",
                    sTitle: "File",
                    visible: true,
                    className: "column-30 fs13--design text-danger",
                    render: function (data, type, row) {
                        return '<a href="' + row.uspImg + '" target="_blank"> View File</a>';
                    }
                },

                {
                    data: "TR_FILEREM",
                    sTitle: "HISTORY",
                    visible: true,
                    className: "fs15--design column-50",
                    render: function (data, type, row) {
                        var html = '';
                        html = '<span class="btn btn-primary btn-block" data-tcd="' + row.TM_TCD + '" onclick="getHistory(this)"><i class="fa fa-history" aria-hidden="true"></i></span>';

                        return html;
                    }
                }

                ];


                DrawTableInquiry = DrawCustomDataTable("uspList", 350,
                    "/route/loadContractSupplier/grid-data", dataColumns, [
                    [0, "asc"]
                ], "frm_grid_search", null, true, true);

                $("#frm_grid_search").validate({
                    errorPlacement: function (error, element) { },
                    submitHandler: function (form) {
                        DrawTableInquiry.ajax.reload();
                    }
                });
                $('.textUpper').on('keyup', function (e) {
                    $(this).val($(this).val().toUpperCase());
                });

                $("form#regForm").submit(function (e) {
                    $('#newUserBox').modal('hide');
                    e.preventDefault();
                });

                $("#regForm").validate({

                    errorPlacement: function (error, element) {
                        offset = element.offset();
                        error.insertAfter(element)
                        error.addClass('message');
                        error.css('display', 'block!important');
                    },
                    submitHandler: function (form) {
                        var $form = $(form);
                        var formData = $form.serializeObject();
                        var method = "post";
                        var url = "/route/loadContractSupplier/create";
                        console.log(formData.id);
                        if (formData.id != 0) {
                            url =
                                '/route/loadContractSupplier/update/' +
                                formData.id;
                            method = "put";
                        }
                        $.ajax({
                            url: url,
                            type: method,
                            contentType: "application/json; charset=utf-8",
                            data: JSON.stringify(formData),
                            //data: formData,
                            dataType: "json",
                            success: function (result) {

                                if (result.status) {
                                    notification({
                                        type: "success",
                                        message: result
                                            .msg
                                    });
                                    DrawTableInquiry.ajax
                                        .reload();
                                    getTourcode();
                                }
                            }
                        });
                    }
                });
            });

            function addNewUser() {
                $('#newUserBox').modal('show');
            }

            function populate(frm, data) {
                $.each(data, function (key, value) {
                    $('[name=' + key + ']', frm).val(value);
                });
                $('.sector').select2();
            }



            function getUser(id) {
                //console.log(id.getAttribute('data-id'));
                var id = id.getAttribute('data-id');

                $.ajax({
                    url: "/route/loadContractSupplier/getData",
                    type: "get",
                    data: {
                        id: id
                    },
                    success: function (result) {

                        var tranNO = '&nbsp;&nbsp;&nbsp;&nbsp;Tran No :- ' + result.data.tranNo;
                        $("#topTranNo").html(tranNO);
                        // var iddata = {
                        //     id: result.data._id
                        // }

                        console.log("hi");
                        console.log(result);
                        //console.log(result.data.firstName);
                        var iddata = {
                            id: result.data._id
                        }
                        // ---------
                        console.log('#regForm', result.data);
                        $.when($('#regForm').populate(result.data)).done(function (x) {

                        });
                        $("#suppliercat").select2();
                        getsupplier();

                        // ------
                        populate('#regForm', result.data);
                        populate('#regForm', iddata);
                        // --------------
                        // setTimeout(()=>{
                        //     $("#supplier").val(result.data.supplier);
                        //     $('.supplier').select2();
                        //     $('#newUserBox').modal('show');
                        // },1000);
                        // $('#newBox').modal('show');
                        //    ------------------
                        $('#newUserBox').modal('show');

                    }
                })
            }









            function getTourcode() {
                $.ajax({
                    url: "/route/TOURNAME/getTourSeries",
                    type: "GET",
                    contentType: "application/json; charset=utf-8",
                    success: function (result) {
                        result = JSON.parse(JSON.stringify(result));
                        var options = '<option value="ALL">- SELECT -</option>';
                        var tourmaneOptions = '<option value="ALL">- SELECT -</option>';
                        var zoneOptions = '<option value="ALL">- SELECT -</option>';
                        for (var i = 0; i < result.length; i++) {
                            options += '<option value=' + result[i].TOURCODE + ' data-TOURCODE="' + result[i].TOURCODE + '">' + result[i].TOURCODE + '</option>';
                            tourmaneOptions += '<option value="' + result[i].TOURNAME + '" data-TOURCODE="' + result[i].TOURCODE + '">' + result[i].TOURNAME + '</option>';
                            zoneOptions += '<option value="' + result[i].TM_ZONE + '" data-TOURCODE="' + result[i].TM_ZONE + '">' + result[i].TM_ZONE + '</option>';
                        }
                        $("#TOURCODE").html(options);
                        $("#TOURCODE").select2();
                        $("#TOURNAME").html(tourmaneOptions);
                        $("#TOURNAME").select2();
                        $("#TOURZONE").html(zoneOptions);
                        $("#TOURZONE").select2();

                    },
                    error: function (jqXHR, textStatus, errorThrown) {
                        alert("Error in loading branch data.Please refresh page");
                    }
                });
            }

            function openNav() {
                document.getElementById("mySidenav").style.width = "250px";
            }

            function closeNav() {
                document.getElementById("mySidenav").style.width = "0";
            }

            $(document).on("change", ".upload_img", function () {
                var $this = $(this);
                var file_data = $(this).prop("files")[0];
                var form_data = new FormData();
                form_data.append("path", "accordions");
                form_data.append("file", file_data);
                $.ajax({
                    url: "/route/upload/aws",
                    type: 'post',
                    data: form_data,
                    cache: false,
                    enctype: 'multipart/form-data',
                    processData: false,
                    contentType: false,
                    success: function (result) {
                        // console.log(result);
                        var data = JSON.stringify(result);
                        data = JSON.parse(data);
                        if (data.url) {
                            $('.uspImg').val(data.url)
                        }
                    }, error: function (jqXHR, textStatus, errorThrown) {
                        var result = jQuery.parseJSON(jqXHR.responseText);
                        $(".custom_error").html(result.message);
                    }
                });
            });
            // -------------------------s----------------

            function setsupplierDetails(e) {
                // console.log(e.value)
                $.ajax({
                    method: "POST",
                    url: "/route/loadContractSupplier/getsupplierDetails",
                    data: JSON.stringify({ F_HLPNAME: e.value }),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (result) {
                        // console.log(result.Data);
                        $('#hotelPlace').val(result.Data.F_PLACE);
                        $('#supplier_category').val(result.Data.F_CATCODE);
                        $('#supplier_no').val(result.Data.F_SUPPNO);


                    }
                });
            }





            function category_list() {
                $.get("/route/loadContractSupplier/category", function (result) {
                    var category_json = "";
                    if (result.length > 0) {
                        category_json = '<option value="">Select Supplier Category</option>'
                        for (var i = 0; i < result.length; i++) {
                            if (result[i] && result[i] != "" && result[i] != "XXXXXXXXXXXX") {
                                if (result[i]) {
                                    category_json += '<option value=' + result[i].toUpperCase() + '>' + result[i].toUpperCase() + '</option>'
                                }
                            }
                        }
                    } else {
                        category_json = "";
                    }
                    $("#F_CATCODE_LIST").html(category_json);
                });
            }

            // -------------------------
            function getsupplier() {
                var catparam = $("#suppliercat").val();

                var tray_url = "/route/rsData/getSupplier/" + catparam;
                $.getJSON(tray_url, function (data) {
                    var optionList1 = '<option value=""></option>';
                    $.each(data.data, function () {
                        if (this != "") {
                            optionList1 += '<option value="' + this.F_NAME + '">' +
                                this.F_NAME + '</option>'
                        }
                    });
                    $('.supplier').html(optionList1);
                    $('.supplier').select2();
                });
            }

            function getsuppliercat() {
                var tray_url = "/route/rsData/getSuppliercat";
                $.getJSON(tray_url, function (data) {
                    var optionList1 = '<option value=""></option>';
                    for (var i = 0; i < data.data.length; i++) {
                        optionList1 += '<option value="' + data.data[i] + '">' +
                            data.data[i] + '</option>'
                    }

                    $('.suppliercat').html(optionList1);
                    $('.suppliercat').select2();
                });
            }

            // ------------------------
            function getHistory(e) {
                var obj = {
                    tourcode: e.getAttribute('data-tcd'),
                };
                $.ajax({
                    url: "/route/operations/getTourmasoData",
                    type: 'post',
                    data: JSON.stringify(obj),
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    success: function (result) {
                        var str = ``;
                        if (result.data.actions) {
                            console.log(result.data.actions);
                            for (var i = 0; i < result.data.actions.length; i++) {
                                str += `<tr>
                <td>${result.data.actions[i].TR_FILEBY}</td>
                <td>${(result.data.actions[i].TR_FILEDT) ? dateFormat(result.data.actions[i].TR_FILEDT) : ''}</td>
                <td>${result.data.actions[i].TR_FILEREM}</td>
                <td>${(result.data.actions[i].action) ? result.data.actions[i].action : ((result.data.actions[i].TR_FILEBY == "") ? 'Lock' : "Unlock")}</td>
                <td>${(result.data.actions[i].actionDoneBy ? result.data.actions[i].actionDoneBy : '')}</td>
              </tr>`;
                            }
                            str += `<tr>
              <td>${result.data.TR_FILEBY}</td>
              <td>${(result.data.TR_FILEDT) ? dateFormat(result.data.TR_FILEDT) : ''}</td>
              <td>${result.data.TR_FILEREM}</td>
              <td>${(result.data.TR_FILEBY == "") ? "Unlock" : 'Lock'}</td>
              <td></td>
            </tr>`;
                            $('#modalBody tbody').html(str);
                            $('#tourfileLockHistory').modal('show');
                        }
                    }
                });
            }

        </script>
        <% include ../partials/footer %>